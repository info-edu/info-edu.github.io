<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Isometric Pro Trainer</title>

<style>
:root { --bg:#0a0a0a; --primary:#00ff00; --accent:#222; }

body {
    font-family: sans-serif;
    background: var(--bg);
    color: var(--primary);
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    height: 100vh;
    justify-content: space-around;
    text-align: center;
}

#weight-display { font-size: 90px; font-weight: 800; margin: 0; }
.unit { font-size: 30px; }
#timer-display { font-size: 48px; color: white; }

.settings {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.input-box {
    background: var(--accent);
    padding: 15px;
    border-radius: 15px;
}

.input-box label {
    font-size: 11px;
    color: #888;
    text-transform: uppercase;
}

.input-box input {
    background: transparent;
    border: none;
    color: white;
    font-size: 28px;
    width: 100%;
    text-align: center;
    outline: none;
}

#main-btn {
    padding: 30px;
    width: 100%;
    font-size: 26px;
    font-weight: bold;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    background: var(--primary);
    color: black;
    transition: 0.2s;
}

#main-btn.stop { background: #ff4444; color: white; }
#main-btn.reconnect { background: #ffaa00; animation: pulse 1.5s infinite; }

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}

#status { font-size: 12px; opacity: 0.6; }

#progress-container {
    background: #1a1a1a;
    border-radius: 6px;
    margin-top: 10px;
}

#progress-bar {
    width: 0%;
    height: 12px;
    background: var(--primary);
    border-radius: 6px;
    transition: 0.1s linear;
}
</style>
</head>

<body>

<div id="status">● DISCONNECTED</div>

<div>
    <p id="weight-display">0.00<span class="unit">kg</span></p>
    <div id="timer-display">00.0s</div>
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
</div>

<div class="settings">
    <div class="input-box">
        <label>Target (kg)</label>
        <input type="number" id="target-w" value="10">
    </div>
    <div class="input-box">
        <label>Goal (sec)</label>
        <input type="number" id="target-t" value="30">
    </div>
</div>

<button id="main-btn">CONNECT SCALE</button>

<script>
/* ---------- STATE ---------- */

const State = {
    DISCONNECTED: "disconnected",
    IDLE: "idle",
    TRAINING: "training",
    COMPLETE: "complete"
};

let appState = State.DISCONNECTED;

/* ---------- VARIABLES ---------- */

let tutMs = 0;
let lastTime = 0;
let currentWeight = 0;
let lastPacket = 0;

let audioCtx;
let wakeLock;

/* ---------- DOM ---------- */

const weightEl = document.getElementById("weight-display");
const timerEl = document.getElementById("timer-display");
const progressEl = document.getElementById("progress-bar");
const mainBtn = document.getElementById("main-btn");
const statusEl = document.getElementById("status");

/* ---------- AUDIO ---------- */

function playBeep(freq, dur) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}

/* ---------- BLE ---------- */

navigator.bluetooth.addEventListener("advertisementreceived", e => {
    lastPacket = Date.now();
    statusEl.innerText = "● LIVE";
    statusEl.style.color = "#00ff00";

    const mData = e.manufacturerData;
    if (!mData || mData.size === 0) return;

    const raw = new DataView(mData.values().next().value.buffer);
    const weightRaw = (raw.getUint8(10) << 8) + raw.getUint8(11);
    currentWeight = weightRaw / 100;

    weightEl.innerHTML = `${currentWeight.toFixed(2)}<span class="unit">kg</span>`;

    if (appState === State.TRAINING) updateTUT();
});

/* ---------- TRAINING LOGIC ---------- */

function updateTUT() {
    const targetW = +document.getElementById("target-w").value;
    const goalS = +document.getElementById("target-t").value;
    const now = Date.now();

    if (currentWeight >= targetW) {
        if (lastTime > 0) {
            const oldSec = Math.floor(tutMs / 1000);
            tutMs += now - lastTime;
            if (Math.floor(tutMs / 1000) > oldSec)
                playBeep(800, 0.05);
        }
        lastTime = now;
    } else {
        lastTime = 0;
    }

    timerEl.innerText = (tutMs / 1000).toFixed(1) + "s";
    progressEl.style.width =
        Math.min(tutMs / (goalS * 1000), 1) * 100 + "%";

    if (tutMs >= goalS * 1000) completeSet();
}

function completeSet() {
    appState = State.COMPLETE;
    playBeep(440, 1.5);

    mainBtn.innerText = "SET COMPLETE";
    mainBtn.className = "";

    setTimeout(startTraining, 2500);
}

function startTraining() {
    tutMs = 0;
    lastTime = 0;
    progressEl.style.width = "0%";
    timerEl.innerText = "00.0s";

    appState = State.TRAINING;
    mainBtn.innerText = "STOP SET";
    mainBtn.className = "stop";
}

function resetToIdle() {
    tutMs = 0;
    lastTime = 0;
    progressEl.style.width = "0%";
    timerEl.innerText = "00.0s";

    appState = State.IDLE;
    mainBtn.innerText = "START TRAINING";
    mainBtn.className = "";
}

/* ---------- BUTTON ---------- */

mainBtn.addEventListener("click", async () => {
    if (!audioCtx) audioCtx = new AudioContext();
    if ("wakeLock" in navigator && !wakeLock)
        wakeLock = await navigator.wakeLock.request("screen");

    try {
        if (appState === State.DISCONNECTED) {
            await navigator.bluetooth.requestLEScan({
                keepRepeatedDevices: true,
                filters: [{ namePrefix: "IF_B7" }]
            });
            appState = State.IDLE;
            mainBtn.innerText = "START TRAINING";
        }
        else if (appState === State.IDLE) {
            startTraining();
        }
        else if (appState === State.TRAINING) {
            resetToIdle();
        }
    } catch (e) {
        console.log("BLE scan cancelled");
    }
});

/* ---------- WATCHDOG ---------- */

setInterval(() => {
    if (Date.now() - lastPacket > 5000) {
        statusEl.innerText = "● OFFLINE (RE-SYNC NEEDED)";
        statusEl.style.color = "red";
        appState = State.DISCONNECTED;
        mainBtn.innerText = "RE-SYNC SCALE";
        mainBtn.className = "reconnect";
    }
}, 2000);

</script>
</body>
</html>
